<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Taylor Arnold and Lauren Tilton">

<title>3&nbsp; EDA II: Organizing Data – Humanities Data in Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04_combine.html" rel="next">
<link href="./02_graphics.html" rel="prev">
<link href="./owl_explore.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7dd7401653f9b7f7a674e3bd3661a20e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_intro.html">Part I: Core</a></li><li class="breadcrumb-item"><a href="./03_verbs.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">EDA II: Organizing Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Humanities Data in Python</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/distant-viewing/hdpy" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Core</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">EDA I: Visualizing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_verbs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">EDA II: Organizing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_combine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">EDA III: Restructuring Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_collect.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Collecting Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Data Types</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_textual_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Textual Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_network_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Network Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_temporal_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Temporal Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_spatial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_image_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Image Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part III: Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_supervised.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Supervised Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_unsupervised.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Unsupervised Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_deeplearning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Deep Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_transformers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Transformers</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Part IV: Programming</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_jsonxml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">JSON + XML</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18_databases.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Databases</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li><a href="#choosing-rows" id="toc-choosing-rows" class="nav-link" data-scroll-target="#choosing-rows"><span class="header-section-number">3.2</span> Choosing Rows</a></li>
  <li><a href="#data-and-layers" id="toc-data-and-layers" class="nav-link" data-scroll-target="#data-and-layers"><span class="header-section-number">3.3</span> Data and Layers</a></li>
  <li><a href="#selecting-columns" id="toc-selecting-columns" class="nav-link" data-scroll-target="#selecting-columns"><span class="header-section-number">3.4</span> Selecting Columns</a></li>
  <li><a href="#arranging-rows" id="toc-arranging-rows" class="nav-link" data-scroll-target="#arranging-rows"><span class="header-section-number">3.5</span> Arranging Rows</a></li>
  <li><a href="#group-by-and-aggregation" id="toc-group-by-and-aggregation" class="nav-link" data-scroll-target="#group-by-and-aggregation"><span class="header-section-number">3.6</span> Group By and Aggregation</a></li>
  <li><a href="#geometries-for-summaries" id="toc-geometries-for-summaries" class="nav-link" data-scroll-target="#geometries-for-summaries"><span class="header-section-number">3.7</span> Geometries for Summaries</a></li>
  <li><a href="#assign" id="toc-assign" class="nav-link" data-scroll-target="#assign"><span class="header-section-number">3.8</span> Assign</a></li>
  <li><a href="#extensions" id="toc-extensions" class="nav-link" data-scroll-target="#extensions"><span class="header-section-number">3.9</span> Extensions</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_intro.html">Part I: Core</a></li><li class="breadcrumb-item"><a href="./03_verbs.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">EDA II: Organizing Data</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-ch03" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">EDA II: Organizing Data</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">3.1</span> Introduction</h2>
<p>In the previous chapter, we learned how to build data visualizations using the grammar of graphics and the <strong>plotnine</strong> package. We saw how these visual techniques allow us to quickly understand the shape and structure of two datasets that have a relatively small number of rows. In order to go farther, we need to be able to modify data directly within Python. The modified dataset can then be used to create new plots, summary tables, or as the input to modeling techniques. For example, we might want to take a subset of the rows of our data to focus on a specific part of the dataset. Or, we might want to create summaries of some of the columns according to different grouping variables defined in the data.</p>
<p>We will use methods called <em>data operations</em> to manipulate datasets in Python. All of the data operations shown in this chapter come from the <strong>pandas</strong> package <span class="citation" data-cites="pandas">[<a href="#ref-pandas" role="doc-biblioref">1</a>]</span>. Each operation takes as an input one DataFrame—the object type introduced in Chapter 1 that is used to represents a dataset—and returns a new DataFrame. There are many operations available in <strong>pandas</strong>, though most are a minor variant or specific application of another operation. In this chapter we will see seven of them, all of which are related to selecting, arranging, and creating rows and columns. First, we will see how to select a subset of rows from the original dataset using boolean indexing and <code>.iloc[]</code>. Then, we use column selection to select a subset of columns from the original dataset. Next, we use the <code>.sort_values()</code> method to sort the rows of our dataset and <code>.assign()</code> to add new columns to the data. Finally, we combine groups of the dataset using the <code>.groupby()</code> method along with aggregation functions. Along with these operations, we will also introduce additional helper functions that assist in making use of their different applications. We will also highlight how each of these operations can be chained together to create new data visualizations.</p>
<p>The set of data operations all have a similar syntax. They typically start with the original DataFrame and the output is always a new DataFrame. Additional options control how the function modifies the data. Because the operations always start with a dataset and return a dataset, we can use method chaining (with the dot operator) to pass a dataset from one operation to the next in order to string together a sequence of data transformations. Importantly, operations never modify the original data by default. They operate instead on a copy of the data. To save the changes, it is necessary to make an explicit name for the new dataset and assign it with the equals operator. Often, though, we will directly chain the resulting transformed version of the data directly into the <code>ggplot</code> command, without the need to make a newly named version of the data.</p>
</section>
<section id="choosing-rows" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="choosing-rows"><span class="header-section-number">3.2</span> Choosing Rows</h2>
<p>It is often useful to take a subset of the rows of an existing dataset. For example, we might want to build a model on a certain sub-population or highlight a particular part of the data in a plot. In the previous chapter we looked at the 30 largest CBSA regions. This dataset was created by taking a subset of the larger, entire set of CBSA regions. A straightforward way to take a subset of rows is to indicate the specific row numbers that we want to extract. In order to select rows by row numbers, we use the <code>.iloc[]</code> indexer, followed by the numbers of the rows we want. The code chunk below shows an example of using the iloc indexer to take the second, fifth, and seventh rows of the data (remembering that Python uses 0-based indexing).</p>
<div id="4b6aee7e" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cbsa.iloc[[<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">quad</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">density</th>
<th data-quarto-table-cell-role="th">age_median</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
<th data-quarto-table-cell-role="th">percent_own</th>
<th data-quarto-table-cell-role="th">rent_1br_median</th>
<th data-quarto-table-cell-role="th">rent_perc_income</th>
<th data-quarto-table-cell-role="th">division</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>Los Angeles</td>
<td>31080</td>
<td>W</td>
<td>-118.148722</td>
<td>34.219406</td>
<td>13.202558</td>
<td>1040.647281</td>
<td>41.6</td>
<td>81652</td>
<td>51.3</td>
<td>1468</td>
<td>33.6</td>
<td>Pacific</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>26420</td>
<td>S</td>
<td>-95.401574</td>
<td>29.787083</td>
<td>7.048954</td>
<td>316.543514</td>
<td>41.0</td>
<td>72551</td>
<td>65.1</td>
<td>997</td>
<td>30.0</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Philadelphia</td>
<td>37980</td>
<td>NE</td>
<td>-75.302635</td>
<td>39.905213</td>
<td>6.215222</td>
<td>506.068130</td>
<td>42.6</td>
<td>79070</td>
<td>71.1</td>
<td>1083</td>
<td>30.0</td>
<td>Middle Atlantic</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As mentioned above, the code here does not change the dataset <code>cbsa</code> itself. It still has all 916 rows even after running the code above. If we want to create a new dataset with just these three regions, we need to explicitly name and assign it. For example, below is an example of how we would create a dataset of the first five cities. We have named the new dataset <code>cbsa_first_five</code>.</p>
<div id="a1b95582" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>cbsa_first_five <span class="op">=</span> cbsa.iloc[<span class="dv">0</span>:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The most common application of the <code>.iloc[]</code> indexer is to take the first set of rows in a dataset. This can be done, for example, after arranging the rows by another variable, something we will see later in the chapter. There are also convenient methods for selecting the first or last rows: <code>.head()</code> and <code>.tail()</code>. For example, in the code below, we show another way to select the first five rows of the dataset.</p>
<div id="5cc17136" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cbsa.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also take a subset of the rows of a dataset by selecting rows based on conditions about the various data columns. To do this we use boolean indexing or the <code>.query()</code> method, which accepts a statement about variables in the dataset. We can write the condition directly in terms of the variable names used in the dataset. Only rows where the statements are true will be returned. For example, below is an example of how we use boolean indexing to select regions that have more than 5 million people living in them.</p>
<div id="b4eeca3c" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cbsa[cbsa[<span class="st">'pop'</span>] <span class="op">&gt;</span> <span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">quad</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">density</th>
<th data-quarto-table-cell-role="th">age_median</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
<th data-quarto-table-cell-role="th">percent_own</th>
<th data-quarto-table-cell-role="th">rent_1br_median</th>
<th data-quarto-table-cell-role="th">rent_perc_income</th>
<th data-quarto-table-cell-role="th">division</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>35620</td>
<td>NE</td>
<td>-74.101056</td>
<td>40.768770</td>
<td>20.011812</td>
<td>1051.306467</td>
<td>42.9</td>
<td>86445</td>
<td>55.3</td>
<td>1430</td>
<td>31.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Los Angeles</td>
<td>31080</td>
<td>W</td>
<td>-118.148722</td>
<td>34.219406</td>
<td>13.202558</td>
<td>1040.647281</td>
<td>41.6</td>
<td>81652</td>
<td>51.3</td>
<td>1468</td>
<td>33.6</td>
<td>Pacific</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Chicago</td>
<td>16980</td>
<td>NC</td>
<td>-87.958820</td>
<td>41.700605</td>
<td>9.607711</td>
<td>508.629406</td>
<td>41.9</td>
<td>78790</td>
<td>68.9</td>
<td>1060</td>
<td>29.0</td>
<td>East North Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>19100</td>
<td>S</td>
<td>-96.970508</td>
<td>32.849480</td>
<td>7.543340</td>
<td>323.181404</td>
<td>41.3</td>
<td>76916</td>
<td>64.1</td>
<td>1106</td>
<td>29.1</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>26420</td>
<td>S</td>
<td>-95.401574</td>
<td>29.787083</td>
<td>7.048954</td>
<td>316.543514</td>
<td>41.0</td>
<td>72551</td>
<td>65.1</td>
<td>997</td>
<td>30.0</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Washington</td>
<td>47900</td>
<td>S</td>
<td>-77.513075</td>
<td>38.812484</td>
<td>6.332069</td>
<td>363.732689</td>
<td>42.4</td>
<td>111252</td>
<td>67.4</td>
<td>1601</td>
<td>28.8</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Philadelphia</td>
<td>37980</td>
<td>NE</td>
<td>-75.302635</td>
<td>39.905213</td>
<td>6.215222</td>
<td>506.068130</td>
<td>42.6</td>
<td>79070</td>
<td>71.1</td>
<td>1083</td>
<td>30.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Miami</td>
<td>33100</td>
<td>S</td>
<td>-80.506307</td>
<td>26.155369</td>
<td>6.105897</td>
<td>430.103162</td>
<td>43.9</td>
<td>62870</td>
<td>60.8</td>
<td>1230</td>
<td>36.8</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Atlanta</td>
<td>12060</td>
<td>S</td>
<td>-84.399567</td>
<td>33.691787</td>
<td>6.026734</td>
<td>263.275821</td>
<td>41.9</td>
<td>75267</td>
<td>67.3</td>
<td>1181</td>
<td>30.3</td>
<td>South Atlantic</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Because population is given in millions of people, we filtered based on <code>pop</code> being greater than <code>5</code>. The output dataset has only 9 rows, compared to the 916 in the original data. Other comparisons can be done with <code>&lt;</code>, <code>&gt;=</code> and <code>&lt;=</code>. There is also a special method called <code>.between()</code> that is often useful. For example, below are all of the regions that have between 1 and 2 million people living in them.</p>
<div id="86399fff" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cbsa[cbsa[<span class="st">'pop'</span>].between(<span class="dv">1</span>, <span class="dv">2</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">quad</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">density</th>
<th data-quarto-table-cell-role="th">age_median</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
<th data-quarto-table-cell-role="th">percent_own</th>
<th data-quarto-table-cell-role="th">rent_1br_median</th>
<th data-quarto-table-cell-role="th">rent_perc_income</th>
<th data-quarto-table-cell-role="th">division</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">35</td>
<td>San Jose</td>
<td>41940</td>
<td>W</td>
<td>-121.372676</td>
<td>36.908496</td>
<td>1.995351</td>
<td>286.417670</td>
<td>41.4</td>
<td>138370</td>
<td>58.5</td>
<td>2227</td>
<td>27.8</td>
<td>Pacific</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">36</td>
<td>Nashville</td>
<td>34980</td>
<td>S</td>
<td>-86.645966</td>
<td>36.118950</td>
<td>1.960999</td>
<td>131.347255</td>
<td>40.6</td>
<td>72537</td>
<td>68.7</td>
<td>1083</td>
<td>29.1</td>
<td>East South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">37</td>
<td>Virginia Beach</td>
<td>47260</td>
<td>S</td>
<td>-76.542499</td>
<td>36.785028</td>
<td>1.791198</td>
<td>183.098156</td>
<td>40.0</td>
<td>71612</td>
<td>64.5</td>
<td>998</td>
<td>30.7</td>
<td>South Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">38</td>
<td>Providence</td>
<td>39300</td>
<td>NE</td>
<td>-71.400290</td>
<td>41.718250</td>
<td>1.668019</td>
<td>381.965971</td>
<td>43.0</td>
<td>74422</td>
<td>66.5</td>
<td>830</td>
<td>29.0</td>
<td>New England</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">39</td>
<td>Jacksonville</td>
<td>27260</td>
<td>S</td>
<td>-81.791535</td>
<td>30.236294</td>
<td>1.581680</td>
<td>178.083158</td>
<td>41.6</td>
<td>66664</td>
<td>67.3</td>
<td>950</td>
<td>30.7</td>
<td>South Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">40</td>
<td>Milwaukee</td>
<td>33340</td>
<td>NC</td>
<td>-88.172713</td>
<td>43.176122</td>
<td>1.571784</td>
<td>407.097337</td>
<td>41.7</td>
<td>67448</td>
<td>64.2</td>
<td>809</td>
<td>28.6</td>
<td>East North Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">41</td>
<td>Oklahoma City</td>
<td>36420</td>
<td>S</td>
<td>-97.505031</td>
<td>35.428987</td>
<td>1.412874</td>
<td>97.737719</td>
<td>40.3</td>
<td>63351</td>
<td>66.4</td>
<td>748</td>
<td>28.0</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42</td>
<td>Raleigh</td>
<td>39580</td>
<td>S</td>
<td>-78.461010</td>
<td>35.756718</td>
<td>1.391801</td>
<td>250.282432</td>
<td>41.8</td>
<td>83581</td>
<td>69.6</td>
<td>1104</td>
<td>28.1</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">43</td>
<td>Memphis</td>
<td>32820</td>
<td>S</td>
<td>-89.869496</td>
<td>35.023319</td>
<td>1.335291</td>
<td>109.877481</td>
<td>42.1</td>
<td>56926</td>
<td>62.2</td>
<td>826</td>
<td>31.2</td>
<td>East South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">44</td>
<td>Richmond</td>
<td>40060</td>
<td>S</td>
<td>-77.446702</td>
<td>37.412085</td>
<td>1.303212</td>
<td>112.159801</td>
<td>42.2</td>
<td>74592</td>
<td>68.7</td>
<td>1035</td>
<td>29.9</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">45</td>
<td>Louisville/Jefferson County</td>
<td>31140</td>
<td>S</td>
<td>-85.681818</td>
<td>38.303038</td>
<td>1.279554</td>
<td>150.206269</td>
<td>42.1</td>
<td>64533</td>
<td>70.2</td>
<td>766</td>
<td>27.2</td>
<td>East South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">46</td>
<td>New Orleans</td>
<td>35380</td>
<td>S</td>
<td>-89.955883</td>
<td>29.924412</td>
<td>1.269037</td>
<td>101.673175</td>
<td>42.1</td>
<td>57656</td>
<td>65.7</td>
<td>887</td>
<td>33.5</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">47</td>
<td>Salt Lake City</td>
<td>41620</td>
<td>W</td>
<td>-113.011235</td>
<td>40.471039</td>
<td>1.244671</td>
<td>59.447488</td>
<td>38.9</td>
<td>82506</td>
<td>72.9</td>
<td>1038</td>
<td>28.4</td>
<td>Mountain</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">48</td>
<td>Hartford</td>
<td>25540</td>
<td>NE</td>
<td>-72.577300</td>
<td>41.734217</td>
<td>1.213324</td>
<td>302.037628</td>
<td>43.7</td>
<td>82359</td>
<td>70.7</td>
<td>982</td>
<td>30.5</td>
<td>New England</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">49</td>
<td>Buffalo</td>
<td>15380</td>
<td>NE</td>
<td>-78.736788</td>
<td>42.909972</td>
<td>1.162523</td>
<td>283.478105</td>
<td>42.5</td>
<td>62282</td>
<td>70.7</td>
<td>714</td>
<td>29.5</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50</td>
<td>Birmingham</td>
<td>13820</td>
<td>S</td>
<td>-86.729411</td>
<td>33.402220</td>
<td>1.109895</td>
<td>93.840306</td>
<td>41.9</td>
<td>62873</td>
<td>72.5</td>
<td>871</td>
<td>29.4</td>
<td>East South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">51</td>
<td>Rochester</td>
<td>40380</td>
<td>NE</td>
<td>-77.507198</td>
<td>42.965737</td>
<td>1.088373</td>
<td>125.643564</td>
<td>42.9</td>
<td>65812</td>
<td>71.3</td>
<td>806</td>
<td>30.6</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">52</td>
<td>Grand Rapids</td>
<td>24340</td>
<td>NC</td>
<td>-85.439269</td>
<td>43.072071</td>
<td>1.081665</td>
<td>152.144573</td>
<td>40.4</td>
<td>70347</td>
<td>77.6</td>
<td>816</td>
<td>29.0</td>
<td>East North Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">53</td>
<td>Tucson</td>
<td>46060</td>
<td>W</td>
<td>-111.789247</td>
<td>32.099121</td>
<td>1.035063</td>
<td>43.455454</td>
<td>40.4</td>
<td>59215</td>
<td>66.3</td>
<td>766</td>
<td>30.6</td>
<td>Mountain</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">55</td>
<td>Tulsa</td>
<td>46140</td>
<td>S</td>
<td>-96.164839</td>
<td>36.249229</td>
<td>1.009982</td>
<td>60.377114</td>
<td>41.5</td>
<td>60866</td>
<td>67.7</td>
<td>734</td>
<td>27.0</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>Fresno</td>
<td>23420</td>
<td>W</td>
<td>-119.653393</td>
<td>36.758521</td>
<td>1.003150</td>
<td>64.453980</td>
<td>39.8</td>
<td>61276</td>
<td>54.5</td>
<td>846</td>
<td>32.5</td>
<td>Pacific</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Sometimes we want to filter based on a character variable in order to select a set of rows based on a specified set of categories. To do this, we can use the <code>.isin()</code> method to select specific categories that we want selected in the output. Below we show an example of selecting only regions in the Northeast (<code>NE</code>) and South (S) quadrants.</p>
<div id="dad76d1b" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cbsa[cbsa[<span class="st">'quad'</span>].isin([<span class="st">'NE'</span>, <span class="st">'S'</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">quad</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">density</th>
<th data-quarto-table-cell-role="th">age_median</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
<th data-quarto-table-cell-role="th">percent_own</th>
<th data-quarto-table-cell-role="th">rent_1br_median</th>
<th data-quarto-table-cell-role="th">rent_perc_income</th>
<th data-quarto-table-cell-role="th">division</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>35620</td>
<td>NE</td>
<td>-74.101056</td>
<td>40.768770</td>
<td>20.011812</td>
<td>1051.306467</td>
<td>42.9</td>
<td>86445</td>
<td>55.3</td>
<td>1430</td>
<td>31.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>19100</td>
<td>S</td>
<td>-96.970508</td>
<td>32.849480</td>
<td>7.543340</td>
<td>323.181404</td>
<td>41.3</td>
<td>76916</td>
<td>64.1</td>
<td>1106</td>
<td>29.1</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>26420</td>
<td>S</td>
<td>-95.401574</td>
<td>29.787083</td>
<td>7.048954</td>
<td>316.543514</td>
<td>41.0</td>
<td>72551</td>
<td>65.1</td>
<td>997</td>
<td>30.0</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Washington</td>
<td>47900</td>
<td>S</td>
<td>-77.513075</td>
<td>38.812484</td>
<td>6.332069</td>
<td>363.732689</td>
<td>42.4</td>
<td>111252</td>
<td>67.4</td>
<td>1601</td>
<td>28.8</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Philadelphia</td>
<td>37980</td>
<td>NE</td>
<td>-75.302635</td>
<td>39.905213</td>
<td>6.215222</td>
<td>506.068130</td>
<td>42.6</td>
<td>79070</td>
<td>71.1</td>
<td>1083</td>
<td>30.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">927</td>
<td>Sweetwater</td>
<td>45020</td>
<td>S</td>
<td>-100.405986</td>
<td>32.303445</td>
<td>0.014727</td>
<td>6.220819</td>
<td>41.2</td>
<td>44700</td>
<td>62.6</td>
<td>577</td>
<td>24.8</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">928</td>
<td>Pecos</td>
<td>37780</td>
<td>S</td>
<td>-103.669712</td>
<td>31.430030</td>
<td>0.014667</td>
<td>1.705080</td>
<td>39.1</td>
<td>53448</td>
<td>74.7</td>
<td>818</td>
<td>27.4</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">929</td>
<td>Zapata</td>
<td>49820</td>
<td>S</td>
<td>-99.168533</td>
<td>27.000573</td>
<td>0.013945</td>
<td>5.081383</td>
<td>41.4</td>
<td>34406</td>
<td>77.1</td>
<td>321</td>
<td>34.6</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">932</td>
<td>Vernon</td>
<td>46900</td>
<td>S</td>
<td>-99.240853</td>
<td>34.080611</td>
<td>0.012887</td>
<td>5.086411</td>
<td>41.5</td>
<td>45262</td>
<td>62.0</td>
<td>503</td>
<td>22.0</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">933</td>
<td>Lamesa</td>
<td>29500</td>
<td>S</td>
<td>-101.947637</td>
<td>32.742488</td>
<td>0.012371</td>
<td>5.291467</td>
<td>41.1</td>
<td>42778</td>
<td>71.5</td>
<td>611</td>
<td>34.5</td>
<td>West South Central</td>
</tr>
</tbody>
</table>

<p>469 rows × 13 columns</p>
</div>
</div>
</div>
<p>As mentioned in the introduction, we can chain together multiple operations to produce more complex logic. For example, consider finding all of the regions with more than 1 million people that are in the Northeast quadrant. We can do this by applying multiple boolean conditions, as in the example below. We can combine multiple conditions using the <code>&amp;</code> (and) and <code>|</code> (or) operators, making sure to use parentheses around each condition.</p>
<div id="1eea6e44" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cbsa[(cbsa[<span class="st">'pop'</span>] <span class="op">&gt;</span> <span class="dv">1</span>) <span class="op">&amp;</span> (cbsa[<span class="st">'quad'</span>].isin([<span class="st">'NE'</span>]))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">quad</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">density</th>
<th data-quarto-table-cell-role="th">age_median</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
<th data-quarto-table-cell-role="th">percent_own</th>
<th data-quarto-table-cell-role="th">rent_1br_median</th>
<th data-quarto-table-cell-role="th">rent_perc_income</th>
<th data-quarto-table-cell-role="th">division</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>35620</td>
<td>NE</td>
<td>-74.101056</td>
<td>40.768770</td>
<td>20.011812</td>
<td>1051.306467</td>
<td>42.9</td>
<td>86445</td>
<td>55.3</td>
<td>1430</td>
<td>31.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>Philadelphia</td>
<td>37980</td>
<td>NE</td>
<td>-75.302635</td>
<td>39.905213</td>
<td>6.215222</td>
<td>506.068130</td>
<td>42.6</td>
<td>79070</td>
<td>71.1</td>
<td>1083</td>
<td>30.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>Boston</td>
<td>14460</td>
<td>NE</td>
<td>-71.099912</td>
<td>42.555194</td>
<td>4.912030</td>
<td>517.827702</td>
<td>42.2</td>
<td>99039</td>
<td>66.4</td>
<td>1390</td>
<td>29.5</td>
<td>New England</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">26</td>
<td>Pittsburgh</td>
<td>38300</td>
<td>NE</td>
<td>-79.830762</td>
<td>40.437868</td>
<td>2.366544</td>
<td>171.198592</td>
<td>43.3</td>
<td>65894</td>
<td>74.9</td>
<td>743</td>
<td>27.1</td>
<td>Middle Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>Providence</td>
<td>39300</td>
<td>NE</td>
<td>-71.400290</td>
<td>41.718250</td>
<td>1.668019</td>
<td>381.965971</td>
<td>43.0</td>
<td>74422</td>
<td>66.5</td>
<td>830</td>
<td>29.0</td>
<td>New England</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">48</td>
<td>Hartford</td>
<td>25540</td>
<td>NE</td>
<td>-72.577300</td>
<td>41.734217</td>
<td>1.213324</td>
<td>302.037628</td>
<td>43.7</td>
<td>82359</td>
<td>70.7</td>
<td>982</td>
<td>30.5</td>
<td>New England</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">49</td>
<td>Buffalo</td>
<td>15380</td>
<td>NE</td>
<td>-78.736788</td>
<td>42.909972</td>
<td>1.162523</td>
<td>283.478105</td>
<td>42.5</td>
<td>62282</td>
<td>70.7</td>
<td>714</td>
<td>29.5</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>Rochester</td>
<td>40380</td>
<td>NE</td>
<td>-77.507198</td>
<td>42.965737</td>
<td>1.088373</td>
<td>125.643564</td>
<td>42.9</td>
<td>65812</td>
<td>71.3</td>
<td>806</td>
<td>30.6</td>
<td>Middle Atlantic</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The results now include only 8 regions. We can use all of these different subsets to create new visualizations, models, and summaries. Let’s now see how we can use data subsets to create new and interesting types of data visualizations.</p>
</section>
<section id="data-and-layers" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="data-and-layers"><span class="header-section-number">3.3</span> Data and Layers</h2>
<p>We know that we could use our newly created subsets of data with plotnine to create visualizations such as those in the previous chapter on different parts of a larger dataset. It is also possible to create new types of visualizations that were previously inaccessible. These will let us understand how a subset of the data relates to the larger collection of data. To start, we will create a dataset that consists only of those regions that have more than 2 million people living in them in order to understand the relationships between larger cities. We store the data in an object called <code>cbsa_large</code>.</p>
<div id="b0c0f347" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cbsa_large <span class="op">=</span> cbsa[cbsa[<span class="st">'pop'</span>] <span class="op">&gt;</span> <span class="dv">2</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cbsa_large</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">quad</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">density</th>
<th data-quarto-table-cell-role="th">age_median</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
<th data-quarto-table-cell-role="th">percent_own</th>
<th data-quarto-table-cell-role="th">rent_1br_median</th>
<th data-quarto-table-cell-role="th">rent_perc_income</th>
<th data-quarto-table-cell-role="th">division</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>35620</td>
<td>NE</td>
<td>-74.101056</td>
<td>40.768770</td>
<td>20.011812</td>
<td>1051.306467</td>
<td>42.9</td>
<td>86445</td>
<td>55.3</td>
<td>1430</td>
<td>31.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Los Angeles</td>
<td>31080</td>
<td>W</td>
<td>-118.148722</td>
<td>34.219406</td>
<td>13.202558</td>
<td>1040.647281</td>
<td>41.6</td>
<td>81652</td>
<td>51.3</td>
<td>1468</td>
<td>33.6</td>
<td>Pacific</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Chicago</td>
<td>16980</td>
<td>NC</td>
<td>-87.958820</td>
<td>41.700605</td>
<td>9.607711</td>
<td>508.629406</td>
<td>41.9</td>
<td>78790</td>
<td>68.9</td>
<td>1060</td>
<td>29.0</td>
<td>East North Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>19100</td>
<td>S</td>
<td>-96.970508</td>
<td>32.849480</td>
<td>7.543340</td>
<td>323.181404</td>
<td>41.3</td>
<td>76916</td>
<td>64.1</td>
<td>1106</td>
<td>29.1</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>26420</td>
<td>S</td>
<td>-95.401574</td>
<td>29.787083</td>
<td>7.048954</td>
<td>316.543514</td>
<td>41.0</td>
<td>72551</td>
<td>65.1</td>
<td>997</td>
<td>30.0</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Washington</td>
<td>47900</td>
<td>S</td>
<td>-77.513075</td>
<td>38.812484</td>
<td>6.332069</td>
<td>363.732689</td>
<td>42.4</td>
<td>111252</td>
<td>67.4</td>
<td>1601</td>
<td>28.8</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Philadelphia</td>
<td>37980</td>
<td>NE</td>
<td>-75.302635</td>
<td>39.905213</td>
<td>6.215222</td>
<td>506.068130</td>
<td>42.6</td>
<td>79070</td>
<td>71.1</td>
<td>1083</td>
<td>30.0</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Miami</td>
<td>33100</td>
<td>S</td>
<td>-80.506307</td>
<td>26.155369</td>
<td>6.105897</td>
<td>430.103162</td>
<td>43.9</td>
<td>62870</td>
<td>60.8</td>
<td>1230</td>
<td>36.8</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Atlanta</td>
<td>12060</td>
<td>S</td>
<td>-84.399567</td>
<td>33.691787</td>
<td>6.026734</td>
<td>263.275821</td>
<td>41.9</td>
<td>75267</td>
<td>67.3</td>
<td>1181</td>
<td>30.3</td>
<td>South Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Boston</td>
<td>14460</td>
<td>NE</td>
<td>-71.099912</td>
<td>42.555194</td>
<td>4.912030</td>
<td>517.827702</td>
<td>42.2</td>
<td>99039</td>
<td>66.4</td>
<td>1390</td>
<td>29.5</td>
<td>New England</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Phoenix</td>
<td>38060</td>
<td>W</td>
<td>-112.069027</td>
<td>33.186173</td>
<td>4.787811</td>
<td>126.558955</td>
<td>40.7</td>
<td>72211</td>
<td>66.5</td>
<td>1065</td>
<td>29.3</td>
<td>Mountain</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>San Francisco</td>
<td>41860</td>
<td>W</td>
<td>-122.166182</td>
<td>37.780765</td>
<td>4.725584</td>
<td>712.992772</td>
<td>41.9</td>
<td>118547</td>
<td>58.4</td>
<td>1940</td>
<td>28.3</td>
<td>Pacific</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Riverside</td>
<td>40140</td>
<td>W</td>
<td>-116.127488</td>
<td>34.549836</td>
<td>4.580402</td>
<td>64.511974</td>
<td>40.2</td>
<td>73424</td>
<td>65.2</td>
<td>1120</td>
<td>34.0</td>
<td>Pacific</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Detroit</td>
<td>19820</td>
<td>NC</td>
<td>-83.233992</td>
<td>42.718660</td>
<td>4.382832</td>
<td>421.567420</td>
<td>42.9</td>
<td>66878</td>
<td>73.1</td>
<td>811</td>
<td>29.4</td>
<td>East North Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Seattle</td>
<td>42660</td>
<td>W</td>
<td>-121.853072</td>
<td>47.554512</td>
<td>3.971125</td>
<td>256.189989</td>
<td>40.6</td>
<td>97675</td>
<td>64.7</td>
<td>1478</td>
<td>29.1</td>
<td>Pacific</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Minneapolis</td>
<td>33460</td>
<td>NC</td>
<td>-93.273933</td>
<td>45.101345</td>
<td>3.659156</td>
<td>188.297448</td>
<td>41.6</td>
<td>87397</td>
<td>75.0</td>
<td>1035</td>
<td>28.5</td>
<td>West North Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>San Diego</td>
<td>41740</td>
<td>W</td>
<td>-116.734692</td>
<td>33.034088</td>
<td>3.296317</td>
<td>298.781488</td>
<td>39.8</td>
<td>88240</td>
<td>55.7</td>
<td>1518</td>
<td>33.4</td>
<td>Pacific</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>Tampa</td>
<td>45300</td>
<td>S</td>
<td>-82.405645</td>
<td>28.153011</td>
<td>3.146074</td>
<td>452.790117</td>
<td>42.8</td>
<td>61121</td>
<td>67.3</td>
<td>1045</td>
<td>32.1</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Denver</td>
<td>19740</td>
<td>W</td>
<td>-104.896367</td>
<td>39.434353</td>
<td>2.936665</td>
<td>135.070927</td>
<td>40.4</td>
<td>88512</td>
<td>68.2</td>
<td>1340</td>
<td>30.4</td>
<td>Mountain</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>Baltimore</td>
<td>12580</td>
<td>S</td>
<td>-76.579833</td>
<td>39.338100</td>
<td>2.837237</td>
<td>404.661335</td>
<td>42.4</td>
<td>87513</td>
<td>70.6</td>
<td>1132</td>
<td>30.0</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>St. Louis</td>
<td>41180</td>
<td>NC</td>
<td>-90.350830</td>
<td>38.734976</td>
<td>2.815627</td>
<td>134.615515</td>
<td>42.2</td>
<td>69635</td>
<td>73.4</td>
<td>778</td>
<td>28.1</td>
<td>West North Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>Orlando</td>
<td>36740</td>
<td>S</td>
<td>-81.361852</td>
<td>28.433502</td>
<td>2.632721</td>
<td>253.043039</td>
<td>41.0</td>
<td>65086</td>
<td>63.5</td>
<td>1156</td>
<td>33.0</td>
<td>South Atlantic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>Charlotte</td>
<td>16740</td>
<td>S</td>
<td>-80.795443</td>
<td>35.167416</td>
<td>2.625282</td>
<td>177.393426</td>
<td>41.8</td>
<td>69559</td>
<td>68.6</td>
<td>1074</td>
<td>28.1</td>
<td>South Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>San Antonio</td>
<td>41700</td>
<td>S</td>
<td>-98.601799</td>
<td>29.428308</td>
<td>2.529453</td>
<td>132.337510</td>
<td>40.0</td>
<td>65355</td>
<td>66.7</td>
<td>936</td>
<td>30.1</td>
<td>West South Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>Portland</td>
<td>38900</td>
<td>W</td>
<td>-122.479832</td>
<td>45.597144</td>
<td>2.493429</td>
<td>141.406821</td>
<td>41.2</td>
<td>82901</td>
<td>66.1</td>
<td>1262</td>
<td>30.2</td>
<td>Pacific</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>Sacramento</td>
<td>40900</td>
<td>W</td>
<td>-120.999752</td>
<td>38.781108</td>
<td>2.379368</td>
<td>173.268846</td>
<td>41.5</td>
<td>81264</td>
<td>62.7</td>
<td>1156</td>
<td>32.1</td>
<td>Pacific</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>Pittsburgh</td>
<td>38300</td>
<td>NE</td>
<td>-79.830762</td>
<td>40.437868</td>
<td>2.366544</td>
<td>171.198592</td>
<td>43.3</td>
<td>65894</td>
<td>74.9</td>
<td>743</td>
<td>27.1</td>
<td>Middle Atlantic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>Cincinnati</td>
<td>17140</td>
<td>NC</td>
<td>-84.480196</td>
<td>39.100073</td>
<td>2.244329</td>
<td>187.276368</td>
<td>41.7</td>
<td>70308</td>
<td>71.2</td>
<td>714</td>
<td>27.3</td>
<td>East North Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>Austin</td>
<td>12420</td>
<td>S</td>
<td>-97.654303</td>
<td>30.261635</td>
<td>2.234300</td>
<td>201.447732</td>
<td>39.6</td>
<td>85398</td>
<td>64.0</td>
<td>1216</td>
<td>28.8</td>
<td>West South Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>Las Vegas</td>
<td>29820</td>
<td>W</td>
<td>-115.013625</td>
<td>36.213907</td>
<td>2.231147</td>
<td>106.878725</td>
<td>41.0</td>
<td>64210</td>
<td>57.1</td>
<td>1004</td>
<td>31.8</td>
<td>Mountain</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>Kansas City</td>
<td>28140</td>
<td>NC</td>
<td>-94.445801</td>
<td>38.934698</td>
<td>2.176124</td>
<td>114.046901</td>
<td>41.4</td>
<td>73299</td>
<td>69.4</td>
<td>905</td>
<td>27.4</td>
<td>West North Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>Columbus</td>
<td>18140</td>
<td>NC</td>
<td>-82.835789</td>
<td>39.967336</td>
<td>2.122480</td>
<td>169.140160</td>
<td>40.6</td>
<td>71020</td>
<td>65.2</td>
<td>882</td>
<td>26.9</td>
<td>East North Central</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33</td>
<td>Indianapolis</td>
<td>26900</td>
<td>NC</td>
<td>-86.206780</td>
<td>39.746760</td>
<td>2.089990</td>
<td>186.089808</td>
<td>41.2</td>
<td>67330</td>
<td>70.0</td>
<td>832</td>
<td>28.7</td>
<td>East North Central</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">34</td>
<td>Cleveland</td>
<td>17460</td>
<td>NC</td>
<td>-81.685431</td>
<td>41.375244</td>
<td>2.084462</td>
<td>399.998911</td>
<td>43.4</td>
<td>61320</td>
<td>68.9</td>
<td>721</td>
<td>28.3</td>
<td>East North Central</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As we saw in the previous chapter, we can create a scatter plot of the median rental price for a 1 bedroom apartment and the median household income using the following block of code.</p>
<div id="20ece85f" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(ggplot(cbsa_large, aes(<span class="st">'rent_1br_median'</span>, <span class="st">'hh_income_median'</span>)) <span class="op">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    geom_point())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One of the core ideas behind the grammar of graphics is that complex visualizations can be constructed by layering relatively simple elements on top of one another. What if we wanted to put together two layers where one layer uses the <code>cbsa</code> dataset and the other uses <code>cbsa_large</code>? To do this, we can override the default dataset in any geometry layer with the option <code>data =</code>. This will use a different dataset within a particular layer. For example, the code below would produce two sets of points. The first layer (second line of the code) would include all of the regions and the second layer (third line) would only have data from the set of the largest regions.</p>
<div id="42a0df09" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(ggplot(cbsa, aes(<span class="st">'rent_1br_median'</span>, <span class="st">'hh_income_median'</span>)) <span class="op">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    geom_point() <span class="op">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    geom_point(data<span class="op">=</span>cbsa_large))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting plot, however, would not look any different than it would if we were just to plot all of the cities together. The second layer of points would sit unassumingly on top of the rest of the data, with no way of seeing that the largest cities have two sets of black points plotted on top of one another. To rectify this, we can color each layer a different color in order to distinguish them from one another. We will do this by highlighting the largest cities in navy blue, while making the rest of the points a light grey. This plot can be further built up by showing the names of just the rows of the largest cities (including all of the cities would take up far too much space). These changes are shown in the code below.</p>
<div id="ab8ca3b1" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(ggplot(cbsa, aes(<span class="st">'rent_1br_median'</span>, <span class="st">'hh_income_median'</span>)) <span class="op">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    geom_point(color<span class="op">=</span><span class="st">'grey'</span>) <span class="op">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    geom_point(color<span class="op">=</span><span class="st">'navy'</span>, data<span class="op">=</span>cbsa_large) <span class="op">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label<span class="op">=</span><span class="st">'name'</span>), color<span class="op">=</span><span class="st">'navy'</span>, data<span class="op">=</span>cbsa_large, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>              size<span class="op">=</span><span class="dv">8</span>, nudge_y<span class="op">=</span><span class="dv">5000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_verbs_files/figure-html/cell-13-output-1.png" width="672" height="480" class="figure-img"></p>
<figcaption>Plot of the core-based statistical areas in the United States, showing the median price to rent a one-bedroom apartment and the median household income as reported by the 2021 American community survey. Here, regions with greater than two million residents are highlighted in navy and their short names are added as labels.</figcaption>
</figure>
</div>
</div>
</div>
<p>The output of our new plot shows both the largest regions and how they relate to the full set of regions. In general, there is a positive relationship between household income and median apartment rent. This relationship is not a perfect line, though, with some cities appearing relatively more or less affordable, at least for a household with a median income renting a one-bedroom apartment. Also, the largest regions tend to be among the most expensive regions. However, there are smaller regions in the upper right-hand corner of the plot that appear close to the largest cities.</p>
<p>Stepping back from the data itself, we see here already how a relatively small set of commands can be put together in different ways to build a variety of plots. Already, we are making further progress towards building informative and layered graphics with our dataset.</p>
</section>
<section id="selecting-columns" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="selecting-columns"><span class="header-section-number">3.4</span> Selecting Columns</h2>
<p>Now that we have seen how to select a subset of the rows in a dataset, another step would be to select a subset of the columns. To do this, we will make use of column selection with square brackets or the <code>.loc[]</code> indexer. We pass it the names of the variables we want to keep in the output dataset, in the (possibly new) order that we want the columns to be arranged in. Here, for example, is a new version of the <code>cbsa</code> dataset containing only the name of the region, the population, the longitude and latitude, and the household median income.</p>
<div id="a598ed93" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cbsa[[<span class="st">'name'</span>, <span class="st">'pop'</span>, <span class="st">'lon'</span>, <span class="st">'hh_income_median'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">lon</th>
<th data-quarto-table-cell-role="th">hh_income_median</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>20.011812</td>
<td>-74.101056</td>
<td>86445</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Los Angeles</td>
<td>13.202558</td>
<td>-118.148722</td>
<td>81652</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Chicago</td>
<td>9.607711</td>
<td>-87.958820</td>
<td>78790</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>7.543340</td>
<td>-96.970508</td>
<td>76916</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>7.048954</td>
<td>-95.401574</td>
<td>72551</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">928</td>
<td>Pecos</td>
<td>0.014667</td>
<td>-103.669712</td>
<td>53448</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">929</td>
<td>Zapata</td>
<td>0.013945</td>
<td>-99.168533</td>
<td>34406</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">931</td>
<td>Craig</td>
<td>0.013240</td>
<td>-108.207523</td>
<td>58583</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">932</td>
<td>Vernon</td>
<td>0.012887</td>
<td>-99.240853</td>
<td>45262</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">933</td>
<td>Lamesa</td>
<td>0.012371</td>
<td>-101.947637</td>
<td>42778</td>
</tr>
</tbody>
</table>

<p>916 rows × 4 columns</p>
</div>
</div>
</div>
<p>We will find that column selection is not as immediately useful as the row filtering when working interactively in Python. For many tasks, having extra variables around does not effect data visualizations or data models. As we have seen already in the grammar of graphics, the plot always shows all of the available rows, but only uses those columns in the data that we have explicitly mapped to aesthetics. Selecting columns, though, can be useful for displaying results. This is particularly the case when writing code that will be printed—the code in this book is a great example. As we saw above, the household median income column was cut off in the original output but is now visible in the selected dataset version. Removing and reordering unneeded columns will be useful throughout this book when we want to show columns that would otherwise be hidden given the limited width of the page. Finally, removing columns can be useful as a first step in the more complex data reorganization tasks shown in the following chapter. We will discuss these strategies more as the need arises in the following chapters.</p>
</section>
<section id="arranging-rows" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="arranging-rows"><span class="header-section-number">3.5</span> Arranging Rows</h2>
<p>The indexing and boolean filtering operations determine a subset of rows to keep from the original dataset. The <code>.sort_values()</code> method keeps all of the original data but re-orders its rows. It works by giving it one or more variable names. The method sorts the data by the first variable from smallest to largest (or alphabetically for character variables). In the case of ties, the second variable, if given, is used. More variables can be given to further break additional ties. If any ties are not broken by the given variables, the rows in question will retain the order given in the original input dataset. The following block of code provides an example in which we order the dataset first by <code>division</code> and then by <code>pop</code>. We will use column selection to display the columns of the data that are used in the arranging of the rows.</p>
<div id="8c6abdfd" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cbsa.sort_values([<span class="st">'division'</span>, <span class="st">'pop'</span>])[[<span class="st">'name'</span>, <span class="st">'division'</span>, <span class="st">'pop'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">division</th>
<th data-quarto-table-cell-role="th">pop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">874</td>
<td>Connersville</td>
<td>East North Central</td>
<td>0.023393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">870</td>
<td>Scottsburg</td>
<td>East North Central</td>
<td>0.024290</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">847</td>
<td>Greensburg</td>
<td>East North Central</td>
<td>0.026466</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">838</td>
<td>North Vernon</td>
<td>East North Central</td>
<td>0.027619</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">835</td>
<td>Macomb</td>
<td>East North Central</td>
<td>0.027743</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">41</td>
<td>Oklahoma City</td>
<td>West South Central</td>
<td>1.412874</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28</td>
<td>Austin</td>
<td>West South Central</td>
<td>2.234300</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23</td>
<td>San Antonio</td>
<td>West South Central</td>
<td>2.529453</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>West South Central</td>
<td>7.048954</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>West South Central</td>
<td>7.543340</td>
</tr>
</tbody>
</table>

<p>916 rows × 3 columns</p>
</div>
</div>
</div>
<p>In the new dataset all of the regions in the “East North Central” division come up first as a result of this division being first alphabetically. Within each group, the items are sorted from the lowest to highest population. Any ordering can be reversed (i.e., from the highest to the lowest value) by setting the <code>ascending</code> parameter to <code>False</code>. Below is an example that repeats the sorting above, but this time in descending order of population.</p>
<div id="d4a6f443" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>cbsa.sort_values([<span class="st">'division'</span>, <span class="st">'pop'</span>], ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>])[[<span class="st">'name'</span>, <span class="st">'division'</span>, <span class="st">'pop'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">division</th>
<th data-quarto-table-cell-role="th">pop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Chicago</td>
<td>East North Central</td>
<td>9.607711</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Detroit</td>
<td>East North Central</td>
<td>4.382832</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">27</td>
<td>Cincinnati</td>
<td>East North Central</td>
<td>2.244329</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>Columbus</td>
<td>East North Central</td>
<td>2.122480</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33</td>
<td>Indianapolis</td>
<td>East North Central</td>
<td>2.089990</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">927</td>
<td>Sweetwater</td>
<td>West South Central</td>
<td>0.014727</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">928</td>
<td>Pecos</td>
<td>West South Central</td>
<td>0.014667</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">929</td>
<td>Zapata</td>
<td>West South Central</td>
<td>0.013945</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">932</td>
<td>Vernon</td>
<td>West South Central</td>
<td>0.012887</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">933</td>
<td>Lamesa</td>
<td>West South Central</td>
<td>0.012371</td>
</tr>
</tbody>
</table>

<p>916 rows × 3 columns</p>
</div>
</div>
</div>
<p>In the result here, “Chicago” has been placed at the top of the dataset, followed by “Detroit” and “Cincinnati”. These are the three largest regions in the “East North Central” division of the United States. A particularly useful application of this kind of sorting with <code>.sort_values()</code> is to pair it with <code>.head()</code> or <code>.iloc[]</code>. Below, for example, is the code to select the 30 regions in our dataset that have the largest population.</p>
<div id="e0011940" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>cbsa.sort_values(<span class="st">'pop'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is the code that we used to create the smaller version of the <code>cbsa</code> dataset that was used throughout Chapter 2. As we can see, putting these operations together offers a powerful way to explore our data.</p>
</section>
<section id="group-by-and-aggregation" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="group-by-and-aggregation"><span class="header-section-number">3.6</span> Group By and Aggregation</h2>
<p>The two operations, aggregation and <code>.groupby()</code>, are often used in sequence to create interesting new summarized versions of a dataset. We will start with aggregation operations. These functions collapse the rows of a DataFrame using summary functions. To apply aggregation requires specifying exactly how the data should be summarized and in terms of which columns the summary should be done.</p>
<p>As with every operation, we start by taking a dataset and applying an aggregation method. We need to specify which aggregation function to use, such as <code>.mean()</code>, <code>.min()</code>, <code>.max()</code>, <code>.sum()</code>, or <code>.count()</code>. An example will help illustrate how this works. The code below computes the mean (in other words, average) population in each of the CBSA regions.</p>
<div id="10d79e59" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cbsa[<span class="st">'pop'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>np.float64(0.3379417838427948)</code></pre>
</div>
</div>
<p>From the output, we see that the average CBSA region has around 0.33 million residents. We are not constrained to computing just one summary at once, however. We can compute multiple summaries using the <code>.agg()</code> method. To do this, we can pass a dictionary specifying which aggregation functions to apply to which columns. For example, here we compute the mean value of the household median income, the sum of the population across all regions, the maximum median age, and a total count of the number of rows.</p>
<div id="23bba779" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>cbsa.agg({</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'hh_income_median'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pop'</span>: <span class="st">'sum'</span>, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'age_median'</span>: <span class="st">'max'</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'name'</span>: <span class="st">'count'</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>}).rename({<span class="st">'hh_income_median'</span>: <span class="st">'avg_hh_income_median'</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>           <span class="st">'pop'</span>: <span class="st">'sum_pop'</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>           <span class="st">'age_median'</span>: <span class="st">'max_age_median'</span>, </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>           <span class="st">'name'</span>: <span class="st">'count'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>avg_hh_income_median    58466.081878
sum_pop                   309.554674
max_age_median             48.800000
count                     916.000000
dtype: float64</code></pre>
</div>
</div>
<p>Summarizing the dataset to a single set of values can be useful for understanding the general trends in a dataset or highlighting outliers. However, the real power of aggregation comes when we pair it with the <code>.groupby()</code> method. This will allow us to produce summaries within one or more grouping variables in our dataset.</p>
<p>The <code>.groupby()</code> method is a special kind of data operation. The method takes one or more names of variables in the dataset and creates a special grouped object that allows subsequent operations to be applied separately for each group. It makes no direct, visible changes to the dataset and is used only to change the way that other data operations treat the dataset. For example, when we use the <code>.groupby()</code> method, subsequent uses of aggregation functions will produce a summary that describes the properties of variables within the variable used for grouping. The variable name(s) placed inside of the <code>.groupby()</code> method indicate which variable(s) should be used for the groups. For example, we recompute the summary from the previous code block, but this time group the data by the division.</p>
<div id="5ce1f1f7" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(cbsa.groupby(<span class="st">'division'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    .agg({<span class="st">'hh_income_median'</span>: <span class="st">'mean'</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">'pop'</span>: <span class="st">'sum'</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">'age_median'</span>: <span class="st">'max'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">'name'</span>: <span class="st">'count'</span>})</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">'hh_income_median'</span>: <span class="st">'avg_hh_income_median'</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'pop'</span>: <span class="st">'sum_pop'</span>, </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'age_median'</span>: <span class="st">'max_age_median'</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'name'</span>: <span class="st">'count'</span>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">avg_hh_income_median</th>
<th data-quarto-table-cell-role="th">sum_pop</th>
<th data-quarto-table-cell-role="th">max_age_median</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">division</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">East North Central</td>
<td>58998.287500</td>
<td>43.308362</td>
<td>46.6</td>
<td>160</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">East South Central</td>
<td>49271.568421</td>
<td>16.731891</td>
<td>46.4</td>
<td>95</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Middle Atlantic</td>
<td>62316.318182</td>
<td>42.117002</td>
<td>46.9</td>
<td>66</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Mountain</td>
<td>63649.376344</td>
<td>23.364852</td>
<td>47.4</td>
<td>93</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">New England</td>
<td>73872.653846</td>
<td>14.400133</td>
<td>48.8</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Pacific</td>
<td>68737.351351</td>
<td>50.721772</td>
<td>47.1</td>
<td>74</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">South Atlantic</td>
<td>54863.085526</td>
<td>61.832725</td>
<td>48.7</td>
<td>152</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">West North Central</td>
<td>60065.508333</td>
<td>19.362469</td>
<td>46.4</td>
<td>120</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">West South Central</td>
<td>52675.646154</td>
<td>37.715468</td>
<td>47.5</td>
<td>130</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We see that the output dataset contains a row for each value of the grouping variable (<code>division</code>) as well as the newly created summary variables. The summarized variable names are the same as the non-grouped version after renaming. However, the output dataset now contains nine rows, one for each division. The output here is now a full dataset that we could try to visualize, in order to understand variations in these economic metrics across larger areas of the United States.</p>
</section>
<section id="geometries-for-summaries" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="geometries-for-summaries"><span class="header-section-number">3.7</span> Geometries for Summaries</h2>
<p>We can use summarized datasets to produce new data visualizations. For example, consider summarizing the household median income and average age for each division of the country. We can take this data and construct a scatter plot that shows the average median income and average median age for each division, along with informative labels. Code to produce the visualization is given below.</p>
<div id="b638260b" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> (cbsa.groupby(<span class="st">'division'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    .agg({<span class="st">'hh_income_median'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">'pop'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">'age_median'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">'name'</span>: <span class="st">'count'</span>})</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">'hh_income_median'</span>: <span class="st">'avg_hh_income_median'</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'pop'</span>: <span class="st">'avg_pop'</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'age_median'</span>: <span class="st">'avg_age_median'</span>, </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'name'</span>: <span class="st">'n'</span>})</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    .reset_index())</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>(ggplot(summary_data, aes(<span class="st">'avg_hh_income_median'</span>, <span class="st">'avg_age_median'</span>)) <span class="op">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    geom_point(aes(size<span class="op">=</span><span class="st">'n'</span>), color<span class="op">=</span><span class="st">'grey'</span>) <span class="op">+</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label<span class="op">=</span><span class="st">'division'</span>), nudge_y<span class="op">=</span><span class="fl">0.3</span>, size<span class="op">=</span><span class="dv">8</span>) <span class="op">+</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    scale_size_area())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_verbs_files/figure-html/cell-21-output-1.png" width="672" height="480" class="figure-img"></p>
<figcaption>Plot showing the average household median income and average median age based on the geographic division using data from the core-based statistical areas in the as reported by the 2021 American community survey.</figcaption>
</figure>
</div>
</div>
</div>
<p>Scatter plots are often useful for displaying summarized information. The <code>geom_col</code> geometry introduced in the previous chapter is also useful, particularly when combined with counting operations. If we want to create a bar plot that shows the distribution of the total number of rows associated with each category, we can do this by combining the group by and aggregation functions with a plot that uses <code>geom_col</code>. Below is an example that counts the total number of CBSA regions in each division.</p>
<div id="95a9138c" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>division_counts <span class="op">=</span> (cbsa.groupby(<span class="st">'division'</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'n'</span>))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>(ggplot(division_counts, aes(x<span class="op">=</span><span class="st">'n'</span>, y<span class="op">=</span><span class="st">'division'</span>)) <span class="op">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    geom_col(color<span class="op">=</span><span class="st">'black'</span>, fill<span class="op">=</span><span class="st">'white'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_verbs_files/figure-html/cell-22-output-1.png" width="672" height="480" class="figure-img"></p>
<figcaption>Bar plot showing the number of core-based statistical areas found in each division of the United States.</figcaption>
</figure>
</div>
</div>
</div>
<p>The white fill color and black border are often a good-looking starting point. Also, as before, making the bars horizontal will make it easier to read the category names when there are a larger number of categories. As mentioned in the previous chapter, it would be nice to arrange the categories in the plot in the order of their counts. We will see how to make this possible in the final two sections.</p>
<div id="fig-img-verbs" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-img-verbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="img/diagram_verbs.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;3.1: Visual descriptions of the six data verbs intrduced in this chapter."><img src="img/diagram_verbs.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-img-verbs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Visual descriptions of the six data verbs intrduced in this chapter.
</figcaption>
</figure>
</div>
</section>
<section id="assign" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="assign"><span class="header-section-number">3.8</span> Assign</h2>
<p>The final core <strong>pandas</strong> operation that we will look at is the <code>.assign()</code> method. It is used to create a new variable in our dataset based on other variables that are already present. Similar to aggregation functions, this method works by specifying the name of the variable we want to create followed by the code that describes how to construct the variable in terms of the rest of the data.</p>
<p>For an example of using <code>.assign()</code>, consider converting the population of each region from the millions given in the dataset into a new variable that is in terms of hundreds of thousands. This involves multiplying the population variable by <code>10</code>. In the code below, we use the assign method to create a new variable named <code>pop_100k</code> that is defined as 10 times the <code>pop</code> variable. We will use column selection to highlight the variables that are involved in the calculation.</p>
<div id="804a6841" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cbsa.assign(pop_100k<span class="op">=</span>cbsa[<span class="st">'pop'</span>] <span class="op">*</span> <span class="dv">10</span>)[[<span class="st">'name'</span>, <span class="st">'pop'</span>, <span class="st">'pop_100k'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">pop_100k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>20.011812</td>
<td>200.11812</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Los Angeles</td>
<td>13.202558</td>
<td>132.02558</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Chicago</td>
<td>9.607711</td>
<td>96.07711</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>7.543340</td>
<td>75.43340</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>7.048954</td>
<td>70.48954</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">928</td>
<td>Pecos</td>
<td>0.014667</td>
<td>0.14667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">929</td>
<td>Zapata</td>
<td>0.013945</td>
<td>0.13945</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">931</td>
<td>Craig</td>
<td>0.013240</td>
<td>0.13240</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">932</td>
<td>Vernon</td>
<td>0.012887</td>
<td>0.12887</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">933</td>
<td>Lamesa</td>
<td>0.012371</td>
<td>0.12371</td>
</tr>
</tbody>
</table>

<p>916 rows × 3 columns</p>
</div>
</div>
</div>
<p>Notice that there is a new variable named <code>pop_100k</code>. This new variable was added as the last column in the dataset, but we have rearranged the ordering using column selection. We can also modify an existing column in the dataset by using the name of an existing variable, or by direct assignment with the bracket notation. In this case the position of the variable within the DataFrame does not change.</p>
<p>The assign method itself has a relatively straightforward syntax. The main challenge is knowing how to apply and chain together the various transformations that are useful within an analysis. Let’s see some common types of operations that will be useful in subsequent applications.</p>
<p>Many of the uses for creating new variables involve assigning one value when a set of conditions is true and another if the conditions are false. For example, consider creating a new character variable called <code>region_size</code> based on the population of each region. We might classify a region as being “large” if it has more than 7 million people and “small” otherwise. In order to create a variable like this, we need the function <code>np.where()</code>. The <code>np.where()</code> function has three parts: a TRUE/FALSE condition, the value to use when the condition is true, and the value to use when it is false. Below is an example showing the construction of the new variable <code>region_size</code>, where we have selected the relevant variables.</p>
<div id="579d2c32" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(cbsa.assign(region_size<span class="op">=</span>np.where(cbsa[<span class="st">'pop'</span>] <span class="op">&gt;</span> <span class="dv">7</span>, <span class="st">'large'</span>, <span class="st">'small'</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">'name'</span>, <span class="st">'pop'</span>, <span class="st">'region_size'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">pop</th>
<th data-quarto-table-cell-role="th">region_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>New York</td>
<td>20.011812</td>
<td>large</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Los Angeles</td>
<td>13.202558</td>
<td>large</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Chicago</td>
<td>9.607711</td>
<td>large</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dallas</td>
<td>7.543340</td>
<td>large</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Houston</td>
<td>7.048954</td>
<td>large</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">928</td>
<td>Pecos</td>
<td>0.014667</td>
<td>small</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">929</td>
<td>Zapata</td>
<td>0.013945</td>
<td>small</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">931</td>
<td>Craig</td>
<td>0.013240</td>
<td>small</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">932</td>
<td>Vernon</td>
<td>0.012887</td>
<td>small</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">933</td>
<td>Lamesa</td>
<td>0.012371</td>
<td>small</td>
</tr>
</tbody>
</table>

<p>916 rows × 3 columns</p>
</div>
</div>
</div>
<p>Looking at the first several rows of data, we see that there are five regions classified as large, with all of the others classified as small. This classification can be used just like any other character variable. For example, we could group by it and then see summary statistics broken out by small and large regions. Or, we could build a plot where the small and large regions have different colors.</p>
<p>The <code>np.where()</code> function can be used to produce any number of categories by using it multiple times. Let’s modify our region size variable to now have five categories: “huge” (over 7 million), “large” (2-7 million), and “medium” (between 1-2 million), “small” (0.3 to 1 million), and the remainder “tiny”. There are several different ways to get to the same result. One of the best and easiest to understand is to start by assigning a default value and then changing the value of the new variable in sequence. For example, below is a code block that creates the new categories and then summarizes the data based on the categories. We have replaced the variable name <code>region_size</code> with <code>rs</code> in order to make sure the code fits easily on the page.</p>
<div id="f619c983" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> (cbsa.assign(rs<span class="op">=</span><span class="st">'default'</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    .assign(rs<span class="op">=</span><span class="kw">lambda</span> x: np.where(x[<span class="st">'pop'</span>] <span class="op">&gt;</span> <span class="dv">7</span>, <span class="st">'huge'</span>, x[<span class="st">'rs'</span>]))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    .assign(rs<span class="op">=</span><span class="kw">lambda</span> x: np.where(x[<span class="st">'pop'</span>].between(<span class="dv">2</span>, <span class="dv">7</span>), <span class="st">'large'</span>, x[<span class="st">'rs'</span>]))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    .assign(rs<span class="op">=</span><span class="kw">lambda</span> x: np.where(x[<span class="st">'pop'</span>].between(<span class="dv">1</span>, <span class="dv">2</span>), <span class="st">'medium'</span>, x[<span class="st">'rs'</span>]))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    .assign(rs<span class="op">=</span><span class="kw">lambda</span> x: np.where(x[<span class="st">'pop'</span>].between(<span class="fl">0.3</span>, <span class="dv">1</span>), <span class="st">'small'</span>, x[<span class="st">'rs'</span>]))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    .assign(rs<span class="op">=</span><span class="kw">lambda</span> x: np.where(x[<span class="st">'pop'</span>] <span class="op">&lt;</span> <span class="fl">0.3</span>, <span class="st">'tiny'</span>, x[<span class="st">'rs'</span>]))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'rs'</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    .agg({<span class="st">'pop'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'sum'</span>], <span class="st">'name'</span>: <span class="st">'count'</span>})</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten column names for cleaner output</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>result.columns <span class="op">=</span> [<span class="st">'pop_min'</span>, <span class="st">'pop_max'</span>, <span class="st">'pop_sum'</span>, <span class="st">'n'</span>]</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pop_min</th>
<th data-quarto-table-cell-role="th">pop_max</th>
<th data-quarto-table-cell-role="th">pop_sum</th>
<th data-quarto-table-cell-role="th">n</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">rs</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">huge</td>
<td>7.05</td>
<td>20.01</td>
<td>57.41</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">large</td>
<td>2.08</td>
<td>6.33</td>
<td>100.94</td>
<td>29</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">medium</td>
<td>1.00</td>
<td>2.00</td>
<td>28.51</td>
<td>21</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">small</td>
<td>0.31</td>
<td>0.97</td>
<td>60.14</td>
<td>108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">tiny</td>
<td>0.01</td>
<td>0.30</td>
<td>62.55</td>
<td>753</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In each <code>.assign()</code> step we are telling the method that if the condition is false, set <code>rs</code> equal to itself (using lambda functions to reference the current state of the DataFrame). In other words, if the condition does not hold, do not change the value of the variable. Notice that the <code>.between()</code> method we used with filtering becomes very helpful once again.</p>
<p>We may wonder why we created a “default” value for the variable <code>rs</code>. It would have been one less line of code to set the default value to “tiny” and remove the final assign function. The reason for the approach above is three-fold. First, it’s easier to understand what the code is doing in its current format because each condition (“huge”, “large”, “medium”, “small”, and “tiny”) is explicitly coded. Secondly, it creates a nice check on our code and data. If we find a row of the output that still has the value “default” we will know that there is a problem somewhere. Finally, the code above will more safely handle the issues with missing values, an issue that we will return to in future chapters.</p>
<p>Another reason to create new variables is to handle the formatting of character variables such as <code>quad</code> and <code>division</code> in our <code>cbsa</code> dataset. Pandas has a special data type called a <em>categorical</em> that is specifically designed to handle character variables with a defined set of categories. It is typically not necessary to store data as categorical during most operations, but it can be useful to create a categorical variable just prior to creating a data visualization or model. From the perspective of data analysis, the biggest difference between regular string columns and categorical columns is that a categorical column has a default order of its unique values, called the <em>category order</em>. Creating categorical variables allows us to change the ordering of categories within visualizations and models. As we have seen, these by default are ordered alphabetically for string variables, but will be done in the order specified by the category levels in the case of a categorical variable.</p>
<p>One way to produce a categorical variable with a given order is to first sort the data in the desired order, then create the categorical variable using the unique values in that order. Combining this with the <code>.sort_values()</code> method provides a lot of control over how categories become ordered. In the code below, for example, we recreate the previous bar plot, but this time arranges the categories and then forces the categories to be in the order specified in the data.</p>
<div id="376cd4a7" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>division_counts_ordered <span class="op">=</span> (cbsa.groupby(<span class="st">'division'</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'n'</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'n'</span>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create categorical with the order from the sorted data</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>division_counts_ordered[<span class="st">'division'</span>] <span class="op">=</span> pd.Categorical(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    division_counts_ordered[<span class="st">'division'</span>], </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    categories<span class="op">=</span>division_counts_ordered[<span class="st">'division'</span>].tolist(),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    ordered<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>(ggplot(division_counts_ordered, aes(x<span class="op">=</span><span class="st">'n'</span>, y<span class="op">=</span><span class="st">'division'</span>)) <span class="op">+</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    geom_col(color<span class="op">=</span><span class="st">'black'</span>, fill<span class="op">=</span><span class="st">'white'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_verbs_files/figure-html/cell-26-output-1.png" width="672" height="480" class="figure-img"></p>
<figcaption>Plot showing the number of core-based statistical areas found in each division of the United States. Here, the categories are ordered by their counts.</figcaption>
</figure>
</div>
</div>
</div>
<p>The output shows that our plot is now ordered by the number of regions in each division. This can be a much better way of understanding the distribution of a character variable. Notice in the code that we overwrote the variable <code>division</code> rather than creating a new variable. This is a common practice when our modification is changing the data type of a column rather than changing the values themselves, such as in the example above where we converted the <code>division</code> variable from a string into a categorical variable. Other useful functions for manipulating categories in pandas include setting categories manually with <code>pd.Categorical()</code> and various string manipulation methods. We will see these in several of the application chapters when creating plots to better understand our data.</p>
</section>
<section id="extensions" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="extensions"><span class="header-section-number">3.9</span> Extensions</h2>
<p>The methods in this chapter provide the primary building blocks for modifying and organizing existing datasets. We will continue to learn new techniques that combine information across datasets (joins) and interchange the relationships between rows and columns (pivots) in Chapter 4. Much of the further power of the techniques shown here come not from new packages, options, and methods, but rather creating complex sequences of the operations we have already seen. Examples of this will be shown throughout the remainder of this book. There are many operations that we have not covered in this chapter that are available in <strong>pandas</strong>. As mentioned above, we tend to focus on the most commonly used operations in the name of simplicity, though pandas offers many specialized methods for specific use cases. For example, there are various ways to handle missing data, string operations, date/time manipulations, and more. When encountering other code that uses these specialized methods, the <strong>pandas</strong> documentation is the best source for understanding how they work.</p>
<p>The data operations introduced in this chapter are all grounded in the theory of a field called relational algebra <span class="citation" data-cites="silberschatz2011database">[<a href="#ref-silberschatz2011database" role="doc-biblioref">2</a>]</span>. The theory itself is not particularly enlightening for data analysis work. The details are mostly useful for people designing databases and interfaces. However, the consequences of this theoretical underpinning are important to know. Because <strong>pandas</strong> is based on these ideas, the concepts presented in this chapter have analogs in many other programming languages and most database systems. For example, the R <strong>dplyr</strong> library has functionality for modifying data tables in R using the same concepts presented that are presented above (often with the same or similar names) <span class="citation" data-cites="wickham2023r">[<a href="#ref-wickham2023r" role="doc-biblioref">3</a>]</span>. The same can be said for SQL, a standard query language for databases, and its variants <span class="citation" data-cites="date1989guide">[<a href="#ref-date1989guide" role="doc-biblioref">4</a>]</span>. Many of the names—such as filtering, summarizing, and grouping—used in <strong>pandas</strong> correspond directly to operations in SQL. These links are important because it means that we can translate concepts shown in this chapter to other situations where we might need to use a different programming language.</p>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>


<div id="refs" class="references csl-bib-body" role="list">
<div id="ref-pandas" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">McKinney, W and others (2011 ). Pandas: A foundational python library for data analysis and statistics. <em>Python for high performance and scientific computing</em>. Dallas, TX. <strong>14</strong> 1–9</div>
</div>
<div id="ref-silberschatz2011database" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">Silberschatz, A, Korth, H F and Sudarshan, S (2011 ). Database system concepts. McGraw-Hill Education</div>
</div>
<div id="ref-wickham2023r" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">Wickham, H, Çetinkaya-Rundel, M and Grolemund, G (2023 ). <em>R for Data Science</em>. " O’Reilly Media, Inc."</div>
</div>
<div id="ref-date1989guide" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">Date, C J (1989 ). <em>A Guide to the SQL Standard</em>. Addison-Wesley Longman Publishing Co., Inc.</div>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/distant-viewing\.github\.io\/hdpy");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02_graphics.html" class="pagination-link" aria-label="EDA I: Visualizing Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">EDA I: Visualizing Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04_combine.html" class="pagination-link" aria-label="EDA III: Restructuring Data">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">EDA III: Restructuring Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Taylor Arnold and Lauren Tilton</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>A <a href="https://distantviewing.org/">Distant Viewing Lab</a> project</p>
</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>